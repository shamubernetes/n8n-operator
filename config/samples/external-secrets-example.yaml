# Example: Using External Secrets Operator with n8n-operator
#
# This shows how to use ESO to fetch secrets from 1Password (or any backend)
# and have the n8n-operator consume them.
#
# Flow:
# 1. ExternalSecret fetches from 1Password/Vault/AWS SM/etc.
# 2. ESO creates a Kubernetes Secret
# 3. N8nCredential references that Secret
# 4. n8n-operator syncs to n8n

---
# Step 1: ExternalSecret fetches credentials from 1Password
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: services
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: op-secret-store        # Your ClusterSecretStore
    kind: ClusterSecretStore
  target:
    name: postgres-credentials   # Name of the K8s Secret to create
    creationPolicy: Owner
  data:
    - secretKey: POSTGRES_HOST
      remoteRef:
        key: postgres-database   # 1Password item name
        property: host
    - secretKey: POSTGRES_USER
      remoteRef:
        key: postgres-database
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-database
        property: password
    - secretKey: POSTGRES_DATABASE
      remoteRef:
        key: postgres-database
        property: database
---
# Step 2: N8nCredential references the Secret created by ESO
apiVersion: n8n.n8n.io/v1alpha1
kind: N8nCredential
metadata:
  name: postgres-account
  namespace: services
spec:
  n8nInstance:
    url: http://n8n.services.svc:5678
    apiKeySecretRef:
      name: n8n-api-key
      key: api-key
  credentialName: "Postgres account"
  credentialType: postgres
  secretRef:
    name: postgres-credentials  # References the ESO-managed Secret
  fieldMappings:
    host: POSTGRES_HOST
    user: POSTGRES_USER
    password: POSTGRES_PASSWORD
    database: POSTGRES_DATABASE
  data:
    port: "5432"
    ssl: "disable"
    sshAuthenticateWith: "password"
    sshHost: ""
    sshPort: "22"
    sshUser: ""
    sshPassword: ""
    privateKey: ""
    passphrase: ""
---
# Example with Vault backend
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-token
  namespace: services
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: api-token
    creationPolicy: Owner
  data:
    - secretKey: token
      remoteRef:
        key: secret/data/api-credentials
        property: token
---
apiVersion: n8n.n8n.io/v1alpha1
kind: N8nCredential
metadata:
  name: api-auth
  namespace: services
spec:
  n8nInstance:
    url: http://n8n.services.svc:5678
    apiKeySecretRef:
      name: n8n-api-key
      key: api-key
  credentialName: "API Auth"
  credentialType: httpHeaderAuth
  secretRef:
    name: api-token
  fieldMappings:
    value: token
  data:
    name: "X-API-Key"
